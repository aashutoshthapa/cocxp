<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CoC Tools - Clash of Clans XP Calculator & Season Rank Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Ultimate CoC tools for Clash of Clans: Calculate XP for player and clan levels, and track global season rankings with our real-time leaderboard tracker.">
  <meta name="keywords" content="Clash of Clans, CoC Tools, XP calculator, Rank Tracker, CoC Leaderboard, Player Rankings, Clan XP, Level Calculator">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://cocxp.vercel.app/">
  <meta property="og:title" content="CoC Tools - Clash of Clans XP Calculator & Rank Tracker">
  <meta property="og:description" content="The most accurate XP calculator and global rank tracker for Clash of Clans players and clans.">
  <meta property="og:image" content="https://cocxp.vercel.app/og-image.png">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://cocxp.vercel.app/">
  <meta property="twitter:title" content="CoC Tools - Clash of Clans XP Calculator & Rank Tracker">
  <meta property="twitter:description" content="The most accurate XP calculator and global rank tracker for Clash of Clans players and clans.">
  <meta property="twitter:image" content="https://cocxp.vercel.app/og-image.png">

  <link rel="canonical" href="https://cocxp.vercel.app/">
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "CoC Tools",
    "alternateName": "Clash of Clans XP Calculator & Rank Tracker",
    "url": "https://cocxp.vercel.app/",
    "description": "Calculate Clash of Clans XP and track global season rankings.",
    "applicationCategory": "Tool, Game",
    "genre": "Strategy",
    "browserRequirements": "Requires JavaScript",
    "softwareVersion": "1.2.0",
    "operatingSystem": "All"
  }
  </script>

  <script defer src="/_vercel/insights/script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #0077ff;
      --primary-hover: #005fcc;
      --bg: #f5f5f5;
      --card-bg: white;
      --text: #333;
      --muted: #666;
      --border: #ddd;
      --row-alt: #f9f9f9;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px 10px;
      margin: 0;
      box-sizing: border-box;
    }

    .container {
      background: var(--card-bg);
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px; /* Default for XP calc */
      box-sizing: border-box;
      transition: max-width 0.3s ease;
    }

    .container.wide {
      max-width: 1000px; /* Wide for Rank Tracker */
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text);
    }
    h1 { font-size: 28px; }
    h2 { font-size: 24px; }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      color: var(--muted);
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid var(--border);
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
      background: white; /* Ensure visible */
      cursor: pointer;
      position: relative; /* Ensure it stays on top */
      z-index: 2;
    }

    button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease, transform 0.1s;
      font-weight: 600;
    }

    button:hover { background: var(--primary-hover); }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .result {
      margin-top: 20px;
      font-size: 16px;
      text-align: center;
      color: var(--text);
      line-height: 1.5;
      word-break: break-word;
    }
    .result b { color: var(--primary); }

    .toggle-buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .toggle-btn {
      padding: 10px 15px;
      background-color: #e0e0e0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
      margin: 0;
      width: auto;
      margin-top: 0;
    }

    .toggle-btn.active {
      background-color: var(--primary);
      color: white;
    }

    .credit {
      margin-top: 30px;
      text-align: center;
      padding-top: 20px;
      border-top: 1px solid #eee;
      color: #666;
      font-size: 14px;
    }
    .credit a {
      color: #5865F2;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    /* Rank Tracker Specific Styles */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: flex-end;
    }
    .control-group { display: flex; flex-direction: column; flex: 1; min-width: 120px; }
    
    .table-wrapper {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: var(--primary);
      color: white;
      text-align: left;
      padding: 10px;
      font-size: 14px;
    }
    tbody td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 14px; }
    tbody tr:nth-child(even) { background: var(--row-alt); }
    
    .status {
      margin-top: 10px;
      font-size: 14px;
      color: var(--primary);
      text-align: center;
      min-height: 20px;
    }

    @media (max-width: 600px) {
      .controls { flex-direction: column; align-items: stretch; }
      .control-group { width: 100%; }
    }

    /* Spinner */
    button.loading { position: relative; color: transparent !important; pointer-events: none; }
    button.loading::after {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 1.2em; height: 1.2em;
      margin: -0.6em 0 0 -0.6em;
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>
  <div class="container" id="mainContainer">
    <h1>Clash of Clans Tools & Rankings</h1>
    
    <div class="toggle-buttons">
      <button id="playerBtn" class="toggle-btn active" onclick="toggleCalculator('player')">Player XP</button>
      <button id="clanBtn" class="toggle-btn" onclick="toggleCalculator('clan')">Clan XP</button>
      <button id="rankBtn" class="toggle-btn" onclick="toggleCalculator('rank')">Rank Tracker</button>
    </div>
    
    <!-- Player Calculator -->
    <div id="playerCalculator">
      <h2>Player XP Calculator</h2>
      <label for="currentLevel">Current Level</label>
      <input type="number" id="currentLevel" min="1" placeholder="e.g. 257">
      <label for="targetLevel">Target Level</label>
      <input type="number" id="targetLevel" min="2" placeholder="e.g. 300">
      <label for="xpPerHour">XP per Hour (Optional)</label>
      <input type="number" id="xpPerHour" min="1" placeholder="e.g. 5000">
      <button onclick="calculateXP()">Calculate</button>
      <div class="result" id="result"></div>
      <button id="showBreakdown" style="display:none;" onclick="showBreakdown()">Show Breakdown</button>
      <button id="collapseBreakdown" style="display:none;" onclick="collapseBreakdown()">Collapse</button>
      <div class="result" id="breakdown"></div>
    </div>
    
    <!-- Clan Calculator -->
    <div id="clanCalculator" style="display: none;">
      <h2>Clan XP Calculator</h2>
      <label for="currentClanLevel">Current Level</label>
      <input type="number" id="currentClanLevel" min="1" max="50" placeholder="e.g. 18">
      <label for="targetClanLevel">Target Level</label>
      <input type="number" id="targetClanLevel" min="2" max="51" placeholder="e.g. 20">
      <label for="currentClanXP">Current XP Progress</label>
      <input type="number" id="currentClanXP" min="0" placeholder="e.g. 1000">
      <label for="xpPerWar">XP per War</label>
      <input type="number" id="xpPerWar" min="1" placeholder="e.g. 500">
      <button onclick="calculateClanXP()">Calculate</button>
      <div class="result" id="clanResult"></div>
    </div>

    <!-- Rank Tracker -->
    <div id="rankTracker" style="display: none;">
      <h2>Rank Tracker</h2>
      
      <div class="card">
        <label>Season Leaderboard</label>
        <div class="controls">
          <div class="control-group">
            <label for="yearSelect">Year</label>
            <select id="yearSelect"></select>
          </div>
          <div class="control-group">
            <label for="monthSelect">Month</label>
            <select id="monthSelect"></select>
          </div>
          <button id="loadBtn" onclick="loadSeason()">
            <i class="fas fa-calendar-alt"></i> Load
          </button>
        </div>
        <p id="status" class="status"></p>
        <div class="table-wrapper" id="seasonTableWrapper">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Name</th>
                <th>Tag</th>
                <th>Clan</th>
                <th>Trophies</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <label>Search Player Tag</label>
        <div class="controls">
          <div class="control-group">
            <label for="tagInput">Player Tag</label>
            <input type="text" id="tagInput" placeholder="e.g., #ABC123">
          </div>
          <button id="tagSearchBtn" onclick="searchTag()">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
        <p id="tagStatus" class="status"></p>
        <div class="table-wrapper" id="tagTableWrapper">
          <table>
            <thead>
              <tr>
                <th>Season</th>
                <th>Rank</th>
                <th>Name</th>
                <th>Clan</th>
                <th>Trophies</th>
              </tr>
            </thead>
            <tbody id="tagResultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="credit">
      <p>Have questions or suggestions?</p>
      <a href="https://www.reddit.com/user/Sensitive_Theory9360/" target="_blank">
        <i class="fa-brands fa-reddit"></i> @Sensitive_Theory9360
      </a>
    </div>
  </div>

  <script>
    // --- XP CALCULATOR LOGIC ---
    let breakdownData = "";

    function xpForLevel(level) {
      if (level === 1) return 30;
      if (level >= 2 && level <= 200) return 50 * (level - 1);
      if (level >= 201 && level <= 299) return 500 * (level - 200) + 9500;
      if (level >= 300) return 1000 * (level - 300) + 60000;
      return 0;
    }

    function calculateXP() {
      const current = parseInt(document.getElementById("currentLevel").value);
      const target = parseInt(document.getElementById("targetLevel").value);
      const xpRate = parseInt(document.getElementById("xpPerHour").value);
      const resultDiv = document.getElementById("result");
      const breakdownButton = document.getElementById("showBreakdown");
      const collapseButton = document.getElementById("collapseBreakdown");
      const breakdownDiv = document.getElementById("breakdown");

      breakdownDiv.innerHTML = "";
      breakdownButton.style.display = "none";
      collapseButton.style.display = "none";
      breakdownData = "";

      if (isNaN(current) || isNaN(target) || current < 1 || target <= current) {
        resultDiv.innerHTML = "‚ö†Ô∏è Please enter valid current and target levels.";
        return;
      }

      let totalXP = 0;
      for (let lvl = current; lvl < target; lvl++) {
        let xpNext = xpForLevel(lvl);
        totalXP += xpNext;
        breakdownData += `Level ${lvl} ‚Üí ${lvl + 1}: ${xpNext.toLocaleString()} XP<br>`;
      }

      let hoursRequired = (xpRate > 0) ? (totalXP / xpRate).toFixed(2) : "N/A";

      resultDiv.innerHTML = `
        Total XP needed: <b>${totalXP.toLocaleString()}</b><br>
        Estimated hours: <b>${hoursRequired}</b>
      `;

      breakdownButton.style.display = "block";
    }

    function showBreakdown() {
      document.getElementById("breakdown").innerHTML = breakdownData;
      document.getElementById("collapseBreakdown").style.display = "block";
    }

    function collapseBreakdown() {
      document.getElementById("breakdown").innerHTML = "";
      document.getElementById("collapseBreakdown").style.display = "none";
    }

    const clanXPData = {
      2: 500, 3: 1200, 4: 1900, 5: 3100, 6: 3800, 7: 4500, 8: 5200, 9: 5900, 10: 7900,
      11: 8600, 12: 9300, 13: 10000, 14: 10700, 15: 15700, 16: 16400, 17: 17100, 18: 17800, 19: 18500, 20: 23500,
      21: 24200, 22: 24900, 23: 25600, 24: 26300, 25: 31300, 26: 32000, 27: 32700, 28: 33400, 29: 34100, 30: 39100,
      31: 39800, 32: 40500, 33: 41200, 34: 41900, 35: 46900, 36: 47600, 37: 48300, 38: 49000, 39: 49700, 40: 54700,
      41: 55400, 42: 56100, 43: 56800, 44: 57500, 45: 62500, 46: 63200, 47: 63900, 48: 64600, 49: 65300, 50: 70300,
      51: 71000
    };

    function calculateClanXP() {
      const currentLevel = parseInt(document.getElementById("currentClanLevel").value);
      const targetLevel = parseInt(document.getElementById("targetClanLevel").value);
      const currentXP = parseInt(document.getElementById("currentClanXP").value) || 0;
      const xpPerWar = parseInt(document.getElementById("xpPerWar").value);
      const resultDiv = document.getElementById("clanResult");

      if (isNaN(currentLevel) || isNaN(targetLevel) || currentLevel < 1 || targetLevel <= currentLevel) {
        resultDiv.innerHTML = "‚ö†Ô∏è Please enter valid levels.";
        return;
      }

      let totalXPNeeded = 0;
      for (let level = currentLevel; level < targetLevel; level++) {
        if (clanXPData[level + 1]) {
          totalXPNeeded += clanXPData[level + 1];
        }
      }

      let remainingXP = Math.max(0, totalXPNeeded - currentXP);
      let warsRequired = (xpPerWar > 0) ? Math.ceil(remainingXP / xpPerWar) : "N/A";

      resultDiv.innerHTML = `
        Total XP: <b>${totalXPNeeded.toLocaleString()}</b><br>
        Remaining: <b>${remainingXP.toLocaleString()}</b><br>
        Wars needed: <b>${warsRequired}</b>
      `;
    }

    // --- RANK TRACKER LOGIC ---
    let db = null;

    function initSupabase() {
      if (db) return true;
      try {
        if (typeof supabase === 'undefined') {
          console.error("Supabase library not loaded.");
          return false;
        }
        const _0x4a2e = ['aHR0cHM6Ly9kYXp4YnliaXFudXVndXRsb25sdy5zdXBhYmFzZS5jbw==', 'ZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKemRYQmhZbUZ6WlNJc0luSmxaaUk2SW1SaGVuaGllV0pwY1c1MWRXZDFkR3h2Ym14M0lpd2ljbTlzWlNJNkltRnViMjRpTENKcFlYUWlPakUzTmpjNU5EY3dNVFVzSW1WNGNDSTZNakE0TXpVeU16QXhOWDAuMGRQOGUtMk1FWXg1ZC1OVmw1Y2ZDeWdSakpXVnhFaU11akZOcE51UXhnOA=='];
        db = supabase.createClient(atob(_0x4a2e[0]), atob(_0x4a2e[1]));
        return true;
      } catch (e) {
        console.error("Supabase init error:", e);
        return false;
      }
    }

    function populateRankSelects() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      if (!yearSelect || !monthSelect) return;

      yearSelect.innerHTML = '';
      monthSelect.innerHTML = '';

      const currentYear = new Date().getFullYear();
      for (let y = 2026; y >= 2016; y--) {
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        yearSelect.appendChild(opt);
      }
      ['01','02','03','04','05','06','07','08','09','10','11','12'].forEach(m => {
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = m;
        monthSelect.appendChild(opt);
      });
      const now = new Date();
      monthSelect.value = String(now.getMonth() + 1).padStart(2, '0');
    }

    function setLatestSeason() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      const now = new Date();
      yearSelect.value = now.getFullYear();
      monthSelect.value = String(now.getMonth() + 1).padStart(2, '0');
      loadSeason();
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    async function loadSeason() {
      const statusEl = document.getElementById('status');
      const resultsBody = document.getElementById('resultsBody');
      const wrapper = document.getElementById('seasonTableWrapper');
      const btn = document.getElementById('loadBtn');
      
      if (!initSupabase()) {
        statusEl.textContent = '‚ùå Database connection failed. Please refresh or check your internet.';
        return;
      }

      const season = `${document.getElementById('yearSelect').value}-${document.getElementById('monthSelect').value}`;
      statusEl.textContent = `Loading ${season}...`;
      btn.classList.add('loading');
      
      try {
        const { data, error } = await db.from('players').select('*').eq('season', season).order('rank', { ascending: true }).limit(1000);

        if (error) throw error;

        if (!data.length) {
          statusEl.textContent = 'üö´ No data found.';
          wrapper.style.display = 'none';
        } else {
          statusEl.textContent = `‚úÖ Showing top ${data.length} players.`;
          resultsBody.innerHTML = data.map(p => `
            <tr>
              <td>${p.rank}</td>
              <td>${escapeHtml(p.name)}</td>
              <td>${p.tag}</td>
              <td>${escapeHtml(p.clan_name) || '-'}</td>
              <td>${p.trophies || '-'}</td>
            </tr>
          `).join('');
          wrapper.style.display = 'block';
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = '‚ùå Error fetching data.';
      } finally {
        btn.classList.remove('loading');
      }
    }

    async function searchTag() {
      const statusEl = document.getElementById('tagStatus');
      const resultsBody = document.getElementById('tagResultsBody');
      const wrapper = document.getElementById('tagTableWrapper');
      const btn = document.getElementById('tagSearchBtn');

      if (!initSupabase()) {
        statusEl.textContent = '‚ùå Database connection failed. Please refresh or check your internet.';
        return;
      }

      let tag = document.getElementById('tagInput').value.trim().toUpperCase();
      if (!tag.startsWith('#')) tag = '#' + tag;
      document.getElementById('tagInput').value = tag;

      if (tag.length < 4) {
        statusEl.textContent = '‚ö†Ô∏è Enter a valid tag.';
        return;
      }

      statusEl.textContent = `Searching ${tag}...`;
      btn.classList.add('loading');

      try {
        const { data, error } = await db.from('players').select('*').eq('tag', tag).order('season', { ascending: false });

        if (error) throw error;

        if (!data.length) {
          statusEl.textContent = '‚ùå No history found.';
          wrapper.style.display = 'none';
        } else {
          statusEl.textContent = `‚úÖ Found ${data.length} appearance(s).`;
          resultsBody.innerHTML = data.map(p => `
            <tr>
              <td>${p.season}</td>
              <td>${p.rank}</td>
              <td>${escapeHtml(p.name)}</td>
              <td>${escapeHtml(p.clan_name) || '-'}</td>
              <td>${p.trophies || '-'}</td>
            </tr>
          `).join('');
          wrapper.style.display = 'block';
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = '‚ùå Error searching tag.';
      } finally {
        btn.classList.remove('loading');
      }
    }

    // --- TOGGLE LOGIC ---
    function toggleCalculator(type) {
      const sections = ['playerCalculator', 'clanCalculator', 'rankTracker'];
      const buttons = ['playerBtn', 'clanBtn', 'rankBtn'];
      const container = document.getElementById('mainContainer');

      sections.forEach(s => {
        const el = document.getElementById(s);
        if (el) el.style.display = 'none';
      });
      buttons.forEach(b => {
        const el = document.getElementById(b);
        if (el) el.classList.remove('active');
      });

      const activeEl = document.getElementById(type === 'rank' ? 'rankTracker' : type + 'Calculator');
      if (activeEl) activeEl.style.display = 'block';
      
      const activeBtn = document.getElementById(type + 'Btn');
      if (activeBtn) activeBtn.classList.add('active');

      if (type === 'rank') {
        container.classList.add('wide');
      } else {
        container.classList.remove('wide');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      populateRankSelects();
      toggleCalculator('player');
      initSupabase(); // Pre-init if possible
    });

    // Handle Enter key for search
    document.getElementById('tagInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') searchTag();
    });
  </script>
</body>
</html>